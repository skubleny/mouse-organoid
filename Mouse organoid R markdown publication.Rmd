---
title: "Mouse Organoid Analysis"
author: "Daniel Skubleny"
date: "13/01/2021"
output:
  word_document: default
  html_document: 
    fig_width: 9
  pdf_document: default
---

R version 4.1.2 (2021-11-01) -- "Bird Hippie"
Copyright (C) 2021 The R Foundation for Statistical Computing

## Load required libraries
```{r, warning= FALSE, message=FALSE}
library(ggplot2)
library(ggpubr)
library(plyr); library(dplyr)
library(tidyverse)
library(GGally)
library(readxl)
library(ggeffects)
library(ggsci)
library(mgcv)
library(gtsummary)
library(mgcViz)
```

## Import Data
```{r, error=FALSE, warning=FALSE}
urlfile<-'https://raw.githubusercontent.com/skubleny/mouse-organoid/main/Raw%20Data/mouseorganoidR.csv'
mouseorganoidR<-read.csv(urlfile, row.names=1)
```

## Modify column types
```{r}
#Clean up data and organize data types
mouseorganoidR = as.data.frame(mouseorganoidR)
mouseorganoidR$passage = as.numeric(mouseorganoidR$passage)
mouseorganoidR$cohort = as.factor(mouseorganoidR$cohort)
mouseorganoidR$treatment = as.factor(mouseorganoidR$treatment)
mouseorganoidR$treatment_time = as.factor(mouseorganoidR$treatment_time)
mouseorganoidR$treatment = factor(mouseorganoidR$treatment, levels = c("HBSS","UW","HTK"))
mouseorganoidR$treatment_time = factor(mouseorganoidR$treatment_time, levels = c("Control","Fresh","One_day","Two_day"))
mouseorganoidR$passage_name = as.factor(mouseorganoidR$passage_name)
mouseorganoidR$passage_name = relevel(mouseorganoidR$passage_name, "Whole Stomach")

mouseorganoidR_control = mouseorganoidR
mouseorganoidR = mouseorganoidR[-c(1:12),]
```

## Let's investigate the trends of viability and growth rate according to treatment group and treatment times.
#Univariable viability and growth rate by time and by media

#Modify data column for media univariate analysis. 
```{r}
mouseorganoidR$review = ifelse(mouseorganoidR$treatment_time=="Fresh", "Control",
                                ifelse(mouseorganoidR$treatment=="HBSS", "HBSS",
                                        ifelse(mouseorganoidR$treatment=="UW", "UW","HTK")))

mouseorganoidR$review = as.factor(mouseorganoidR$review)

mouseorganoidR$review <- factor(mouseorganoidR$review, levels = c("Control", "HBSS", "UW", "HTK"))



mouseorganoidR$control = ifelse(mouseorganoidR$treatment_time=="Fresh", "Fresh", "24/48 hours")
                                
mouseorganoidR$control = as.factor(mouseorganoidR$control)

mouseorganoidR$control <- factor(mouseorganoidR$control, levels = c("Fresh", "24/48 hours"))
```
#Figure 2C: dissociation viability vs Treatment for 24 and 48 hours. 
```{r}
#Figure 2E
dissviab_media_all = mouseorganoidR %>%
ggplot(aes(x= treatment, y = diss_viability, fill = treatment)) + 
 geom_violin(alpha=0.4, position = position_dodge(width = .75),size=1,color=NA, scale = "count") +
  geom_boxplot(outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + ggbeeswarm::geom_quasirandom(method = "quasirandom", shape = 21,size=3,dodge.width=0.75,  color="black",alpha=0.5,show.legend = F, bandwidth = 1) + 
  stat_compare_means(size = 4.5, label.y = 10, label.x=2, hjust=0.5) +
  ylim(0,100) +
  ylab("Dissociation viability (%)") +
    xlab("Cell Status") +
    scale_x_discrete(name = "Media", labels=c("HBSS", "UW", "HTK")) +
    scale_fill_manual(name="Media",labels=c("HBSS", "UW","HTK"), values = c("#E41A1C", "#377EB8" ,"#4DAF4A")) +
    theme_classic() +
    theme(axis.text.x = element_text(colour="black", size = 14)) +
    theme(axis.text.y = element_text(colour="black",size = 14)) + 
    theme(plot.title = element_text(colour="black", size=14,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_text(colour="black", size =14, vjust = 0.05)) +
    theme(axis.title.y = element_text(colour="black", size=14)) +
    theme(legend.position = "none")
ggsave("dissviab_media_all.svg", dissviab_media_all, width=4, height=3)

#Dunn's
mouseorganoidR %>%
  FSA::dunnTest(diss_viability~ treatment, data=.,method="bonferroni")
```

#Figure 2D: dissociation viability vs Treatment time 
```{r}
dissviab_disstime = ggplot(mouseorganoidR, aes(x= treatment_time, y = diss_viability, fill = treatment_time)) + 
    geom_violin(alpha=0.4, position = position_dodge(width = .75),size=1,color=NA, scale = "count") +
  geom_boxplot(outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + ggbeeswarm::geom_quasirandom(method = "quasirandom", shape = 21,size=3,dodge.width=0.75,  color="black",alpha=0.5,show.legend = F, bandwidth = 1) + 
  stat_compare_means(size = 4.5, label.y = 10, label.x=2, hjust=0.5) +
  ylim(0,100) +
    ylab("Dissociation viability (%)") +
    xlab("Cell Status") +
    scale_x_discrete(name="Dissociation Time",labels=c("Fresh", "24 Hours","48 Hours")) +
    scale_fill_manual(name="Dissociation Time",labels=c("Fresh", "24 Hours","48 Hours"), values = c("#ECE2F0", "#A6BDDB", "#1C9099")) +
    theme_classic() +
    theme(axis.text.x = element_text(colour="black", size = 14)) +
    theme(axis.text.y = element_text(colour="black",size = 14)) + 
    theme(plot.title = element_text(colour="black", size=14,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_text(colour="black", size =14, vjust = 0.05)) +
    theme(axis.title.y = element_text(colour="black", size=14)) +
    theme(legend.position = "none")

ggsave("dissviab_disstime.svg", dissviab_disstime, width=4, height=3)

table(mouseorganoidR$diss_viability>0,mouseorganoidR$treatment_time)

```

#Figure 2E: dissociation viability vs Cohort 
```{r}
#Figure 2E

dissviab_cohort = ggplot(mouseorganoidR, aes(x= cohort, y = diss_viability,fill = cohort)) + 
  geom_violin(alpha=0.4, position = position_dodge(width = .75),size=1,color=NA, scale = "count") +
  geom_boxplot(outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + ggbeeswarm::geom_quasirandom(method = "quasirandom", shape = 21,size=3,dodge.width=0.75,  color="black",alpha=0.5,show.legend = F, bandwidth = 1) + 
  stat_compare_means(size = 4.5, label.y = 10, label.x=3, hjust=0.5) +
  ylim(0,100) +
  ylab("Dissociation viability (%)") +
    xlab("Cell Status") +
    scale_x_discrete(name = "Cohort", labels=c("1", "2","3","4","5")) +
    scale_fill_manual(name="Cohort",labels=c("1", "2","3","4","5"), values = c("#E64B35FF", "#4DBBD5FF", "#00A087FF" ,"#3C5488FF", "#F39B7FFF")) +
    theme_classic() +
    theme(axis.text.x = element_text(colour="black", size = 14)) +
    theme(axis.text.y = element_text(colour="black",size = 14)) + 
    theme(plot.title = element_text(colour="black", size=14,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_text(colour="black", size =14, vjust = 0.05)) +
    theme(axis.title.y = element_text(colour="black", size=14)) +
    theme(legend.position = "none")
ggsave("dissviab_cohort.svg", dissviab_cohort, width=4, height=3)

table(mouseorganoidR$diss_viability>0,mouseorganoidR$cohort)


```

#Figure 2: dissociation viability vs paired boxplot
```{r}
#Figure 2E
dissviab_media_breakdown = mouseorganoidR %>%
ggplot(aes(x= treatment, y = diss_viability, fill = treatment_time)) + 
    geom_violin(alpha=0.4, position = position_dodge(width = .75),size=1,color=NA, scale = "count") +
  geom_boxplot(outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + ggbeeswarm::geom_quasirandom(method = "quasirandom", shape = 21,size=3,dodge.width=0.75,  color="black",alpha=0.5,show.legend = F, bandwidth = 1) + 
  stat_compare_means(size = 4.5, label.y = 10, label.x=2, hjust=0.5) +
  ylim(0,100) +
  ylab("Dissociation viability (%)") +
    xlab("Cell Status") +
    scale_x_discrete(name = "Media", labels=c("HBSS", "UW", "HTK")) +
    scale_fill_manual(name="Dissociation Time",labels=c("Fresh", "24 Hours","48 Hours"), values = c("#ECE2F0", "#A6BDDB", "#1C9099")) +
    theme_classic() +
    theme(axis.text.x = element_text(colour="black", size = 14)) +
    theme(axis.text.y = element_text(colour="black",size = 14)) + 
    theme(plot.title = element_text(colour="black", size=14,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_text(colour="black", size =14, vjust = 0.05)) +
    theme(axis.title.y = element_text(colour="black", size=14)) +
    theme(legend.position = "bottom",
          legend.text = element_text(colour="black",size = 14),
          legend.title = element_text(colour="black",size = 14))
ggsave("dissviab_media_breakdown.svg", dissviab_media_breakdown, width=8, height=4)

```
#Figure 2: dissociation viability vs Fresh only
```{r}
#Figure 2 supplement with Fresh only 
dissviab_media_fresh = mouseorganoidR %>%
  filter(treatment_time=="Fresh") %>%
ggplot(aes(x= treatment, y = diss_viability, fill = treatment)) + 
   geom_violin(alpha=0.4, position = position_dodge(width = .75),size=1,color=NA, scale = "count") +
  geom_boxplot(outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + ggbeeswarm::geom_quasirandom(method = "quasirandom", shape = 21,size=3,dodge.width=0.75,  color="black",alpha=0.5,show.legend = F, bandwidth = 1) + 
  stat_compare_means(size = 4.5, label.y = 10, label.x=2, hjust=0.5) +
  ylim(0,100) +
  ylab("Dissociation viability (%)") +
    xlab("Cell Status") +
    scale_x_discrete(name = "Media", labels=c("HBSS", "UW", "HTK")) +
    scale_fill_manual(name="Media",labels=c("HBSS", "UW","HTK"), values = c("#E41A1C", "#377EB8" ,"#4DAF4A")) +
    theme_classic() +
    theme(axis.text.x = element_text(colour="black", size = 14)) +
    theme(axis.text.y = element_text(colour="black",size = 14)) + 
    theme(plot.title = element_text(colour="black", size=14,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_text(colour="black", size =14, vjust = 0.05)) +
    theme(axis.title.y = element_text(colour="black", size=14)) +
    theme(legend.position = "none")
ggsave("dissviab_media_fresh.svg", dissviab_media_fresh, width=4, height=3)

#Dunn's
mouseorganoidR %>%
  filter(!treatment_time=="Fresh") %>%
  FSA::dunnTest(diss_viability~ treatment, data=.,method="bonferroni")
```

#Figure 2: dissociation viability vs Fresh pooled control vs 24 and 48 hoursr
```{r}
#Figure 2 - not included in supplement 
dissviab_media = mouseorganoidR %>%
ggplot(aes(x= review, y = diss_viability, fill = review)) + 
   geom_violin(alpha=0.4, position = position_dodge(width = .75),size=1,color=NA, scale = "count") +
  geom_boxplot(outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + ggbeeswarm::geom_quasirandom(method = "quasirandom", shape = 21,size=3,dodge.width=0.75,  color="black",alpha=0.5,show.legend = F, bandwidth = 1) + 
  stat_compare_means(size = 4.5, label.y = 10, label.x=2, hjust=0.5) +
  ylim(0,100) +
  ylab("Dissociation viability (%)") +
    xlab("Cell Status") +
    scale_x_discrete(name = "Media", labels=c("Control","HBSS", "UW", "HTK")) +
    scale_fill_manual(name="Media",labels=c("Control","HBSS", "UW","HTK"), values = c("#FC8D59", "#E41A1C", "#377EB8" ,"#4DAF4A")) +
    theme_classic() +
    theme(axis.text.x = element_text(colour="black", size = 14)) +
    theme(axis.text.y = element_text(colour="black",size = 14)) + 
    theme(plot.title = element_text(colour="black", size=14,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_text(colour="black", size =14, vjust = 0.05)) +
    theme(axis.title.y = element_text(colour="black", size=14)) +
    theme(legend.position = "none")
ggsave("dissviab_media.svg", dissviab_media, width=4, height=3)

#Dunn's
mouseorganoidR %>%
  FSA::dunnTest(diss_viability~ review, data=.,method="bonferroni")
```
#########################################################################################################
#########################################################################################################
#Figure 3A and 3B
```{r}
univar_media_viability = ggplot(mouseorganoidR, aes(x = treatment, y = viability, fill=treatment)) + 
  geom_violin(alpha=0.4, position = position_dodge(width = .75),size=1,color=NA) +
  geom_boxplot(notch = TRUE,  outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + ggbeeswarm::geom_quasirandom(method = "pseudorandom", shape = 21,size=2,dodge.width=0.75,  color="black",alpha=0.5,show.legend = F, bandwidth = 1) + 
  scale_fill_manual(name="Media",labels=c("HBSS", "UW","HTK"), values = c("#E41A1C", "#377EB8" ,"#4DAF4A")) +
  xlab("Media") +
  ylab("Viability (%)") +
  ylim(0,100) +
  stat_compare_means(aes(label = paste0("ANOVA = ", after_stat(p.format))),method="anova",size = 5, label.y = 10, label.x=2, hjust=0.5) +
  theme_classic() +
  theme(axis.text.x = element_text(colour="black", size = 16))  +
  theme(axis.text.y = element_text(colour="black",size = 16)) + 
  theme(plot.title = element_text(colour="black", size=16,hjust = 0, vjust=0)) +
  theme(axis.title.x = element_text(colour="black",size = 16)) +
  theme(axis.title.y = element_text(colour="black", size=16)) +
  theme(legend.position = "none") 
  ggsave("univar_media_viability.svg", univar_media_viability, width=3.75, height=4)

univar_time_viability = ggplot(mouseorganoidR, aes(x = treatment_time, y = viability, fill=treatment_time)) + 
  geom_violin(alpha=0.4, position = position_dodge(width = .75),size=1,color=NA) +
  geom_boxplot(notch = TRUE,  outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + ggbeeswarm::geom_quasirandom(method = "pseudorandom", shape = 21,size=2,dodge.width=0.75, color="black",alpha=0.5,show.legend = F, bandwidth = 1) + 
  scale_x_discrete(name="Dissociation Time",labels=c("Fresh", "24 Hours","48 Hours")) +
  scale_fill_manual(name="Dissociation Time",labels=c("Fresh", "24 Hours","48 Hours"), values = c("#D0D1E6", "#3690C0", "#016C59")) +
  ylab("Viability (%)") +
  ylim(0,100) +
  stat_compare_means(aes(label = paste0("ANOVA = ", after_stat(p.format))),method="anova",size = 5, label.y = 10, label.x=2, hjust=0.5) +
  theme_classic() +
  theme(axis.text.x = element_text(colour="black", size = 16))  +
  theme(axis.text.y = element_text(colour="black",size = 16)) + 
  theme(plot.title = element_text(colour="black", size=16,hjust = 0, vjust=0)) +
  theme(axis.title.x = element_text(colour="black",size = 16)) +
  theme(axis.title.y = element_text(colour="black", size=16)) +
  theme(legend.position = "none") 
  ggsave("univar_time_viability.svg", univar_time_viability, width=4, height=4)

#Growth rate

univar_media_GR = ggplot(mouseorganoidR, aes(x = treatment, y = growth_rate, fill=treatment)) + 
  geom_violin(alpha=0.4, position = position_dodge(width = .75),size=1,color=NA) +
  geom_boxplot(notch = TRUE,  outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + ggbeeswarm::geom_quasirandom(method = "pseudorandom", shape = 21,size=2,dodge.width=0.75,  color="black",alpha=0.35,show.legend = F, bandwidth = 1) + 
  scale_fill_manual(name="Media",labels=c("HBSS", "UW","HTK"), values = c("#E41A1C", "#377EB8" ,"#4DAF4A")) +
  xlab("Media") +
  ylab("Relative Growth Rate") +
  ylim(-0.55,1) +
  stat_compare_means(aes(label = paste0("ANOVA = ", after_stat(p.format))),method="anova",size = 5, label.y = 0.9, label.x=0.7, hjust=0) +
  theme_classic() +
  theme(axis.text.x = element_text(colour="black", size = 16))  +
  theme(axis.text.y = element_text(colour="black",size = 16)) + 
  theme(plot.title = element_text(colour="black", size=16,hjust = 0, vjust=0)) +
  theme(axis.title.x = element_text(colour="black",size = 16)) +
  theme(axis.title.y = element_text(colour="black", size=16)) +
  theme(legend.position = "none") 
  ggsave("univar_media_GR.svg", univar_media_GR, width=3.75, height=4)

univar_time_GR = ggplot(mouseorganoidR, aes(x = treatment_time, y = growth_rate, fill=treatment_time)) + 
  geom_violin(alpha=0.4, position = position_dodge(width = .75),size=1,color=NA) +
  geom_boxplot(notch = TRUE,  outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + ggbeeswarm::geom_quasirandom(method = "pseudorandom", shape = 21,size=2,dodge.width=0.75,  color="black",alpha=0.35,show.legend = F, bandwidth = 1) + 
  scale_x_discrete(name="Dissociation Time",labels=c("Fresh", "24 Hours","48 Hours")) +
  scale_fill_manual(name="Dissociation Time",labels=c("Fresh", "24 Hours","48 Hours"), values = c("#D0D1E6", "#3690C0", "#016C59")) +
  ylab("Relative Growth Rate") +
  ylim(-0.55,1) +
  stat_compare_means(aes(label = paste0("ANOVA = ", after_stat(p.format))),method="anova",size = 5, label.y = 0.9, label.x=0.7, hjust=0) +
  theme_classic() +
  theme(axis.text.x = element_text(colour="black", size = 16))  +
  theme(axis.text.y = element_text(colour="black",size = 16)) + 
  theme(plot.title = element_text(colour="black", size=16,hjust = 0, vjust=0)) +
  theme(axis.title.x = element_text(colour="black",size = 16)) +
  theme(axis.title.y = element_text(colour="black", size=16)) +
  theme(legend.position = "none") 
  ggsave("univar_time_GR.svg", univar_time_GR, width=4, height=4)
  
#Dunn's test for growth rate. 
mouseorganoidR %>%
  FSA::dunnTest(growth_rate~ treatment_time, data=.,method="bonferroni")
```


#########################################################################################################
#########################################################################################################

A note about methods: Here I will create an adjusted response plot. I will adjust the variables of viability and growth rate with variables of interest. This is similar to adjusting for batch effects or other known variables of interest. We only have two independent variables thus I fit each individual regression and used the predict() function to find my fitted values From those models the fitted values can be found as well as residuals etc using mod$fitted.values.

#########################################################################################################
#########################################################################################################

#Complex viability models 
```{r}
#Growth Rate

#Here I fit splines and before LR tests to define the optimal df. Later we will compare these spline models to GAM.This is completed for univariable models as well as a multivariable model. 

require(splines, quietly=TRUE)
nfit1 <- lm(viability~ growth_rate ,data = mouseorganoidR)
nfit2 <- lm(viability~ ns(growth_rate, df=2) ,data = mouseorganoidR)
nfit3 <- lm(viability~ ns(growth_rate, df=3) ,data = mouseorganoidR)
nfit4 <- lm(viability~ ns(growth_rate, df=4),data = mouseorganoidR)
nfit5 <- lm(viability~ ns(growth_rate, df=5),data = mouseorganoidR)
nfit6 <- lm(viability~ ns(growth_rate, df=6),data = mouseorganoidR)

    anova(nfit1, nfit2,nfit3,nfit4,nfit5,nfit6)
    #ns df5 wins

mfit <- lm(viability~ ns(growth_rate, df=5),data = mouseorganoidR)
summary(mfit)
termplot(mfit, term=1, se=TRUE, col.term=1, col.se=1)

#Passage
require(splines, quietly=TRUE)
nfit1 <- lm(viability~ passage ,data = mouseorganoidR)
nfit2 <- lm(viability~ ns(passage, df=2) ,data = mouseorganoidR)
nfit3 <- lm(viability~ ns(passage, df=3) ,data = mouseorganoidR)
nfit4 <- lm(viability~ ns(passage, df=4),data = mouseorganoidR)
    anova(nfit1, nfit2,nfit3,nfit4)
    #ns df=3 wins

mfit <- lm(viability~ ns(passage, df=3),data = mouseorganoidR)
summary(mfit)
termplot(mfit, term=1, se=TRUE, col.term=1, col.se=1)

#Days culture
nfit1 <- lm(viability~ days_culture,data = mouseorganoidR)
nfit2 <- lm(viability~  ns(days_culture, df=2),data = mouseorganoidR)
nfit3 <- lm(viability~ ns(days_culture, df=3) ,data = mouseorganoidR)
nfit4 <- lm(viability~ ns(days_culture, df=4) ,data = mouseorganoidR)
nfit5 <- lm(viability~ ns(days_culture, df=5) ,data = mouseorganoidR)
nfit6 <- lm(viability~ ns(days_culture, df=6) ,data = mouseorganoidR)

    anova(nfit1, nfit2,nfit3,nfit4,nfit5,nfit6)
    #ns df=3 wins
    
mfit <- lm(viability~ ns(days_culture, df=3) ,data = mouseorganoidR)
summary(mfit)
termplot(mfit, term=1, se=TRUE, col.term=1, col.se=1)


#Full multivaribable model splines
require(splines, quietly=TRUE)
nfit1 <- lm(viability~ ns(passage, df=1) +treatment+ treatment_time +cohort + ns(days_culture, df=1) +ns(growth_rate, df=5),data = mouseorganoidR)
nfit2 <- lm(viability~ ns(passage, df=2) +treatment+ treatment_time +cohort + ns(days_culture, df=2) +ns(growth_rate, df=5),data = mouseorganoidR)
anova(nfit1, nfit2) #fit2 wins
nfit3 <- lm(viability~ ns(passage, df=3) +treatment+ treatment_time +cohort + ns(days_culture, df=3)+ns(growth_rate, df=5),data = mouseorganoidR)
anova(nfit2, nfit3) #fit 3 wins
nfit4 <- lm(viability~ ns(passage, df=3) +treatment+ treatment_time +cohort + ns(days_culture, df=2)+ns(growth_rate, df=5),data = mouseorganoidR)
anova(nfit3, nfit4) #fit 3 wins because the sum of squares in less in model 4

anova(nfit1, nfit2, nfit3, nfit4) #fit 3 wins because the sum of squares in less in model 4

mfit <- lm(viability~ ns(passage, df=3) +treatment+ treatment_time +cohort + ns(days_culture, df=3),data = mouseorganoidR)
summary(mfit)
termplot(mfit, term=1, se=TRUE, col.term=1, col.se=1)

#Assess growth rate spline vs gam
nfit3 <- lm(viability~ ns(growth_rate, df=5) ,data = mouseorganoidR)
mod_gam1 <- gam(viability ~ s(growth_rate, bs = "cs"), data=mouseorganoidR)
summary(mod_gam1)

anova(nfit3, mod_gam1, test="Chisq")

#Asssess passage spline vs gam
nfit3 <- lm(viability~ ns(passage, df=3) ,data = mouseorganoidR)
library(mgcv)
mod_gam1 <- gam(viability ~ s(passage, bs = "cs"), data=mouseorganoidR)
summary(mod_gam1)

anova(nfit3, mod_gam1, test="Chisq")
#Gam is not significant but has better adj Rsq

#Assess days_culture spline vs gam
nfit4 <- lm(viability~ ns(days_culture, df=3) ,data = mouseorganoidR)
library(mgcv)
mod_gam1 <- gam(viability ~ s(days_culture, bs = "cs",k=9), data=mouseorganoidR)
summary(mod_gam1)

anova(nfit4, mod_gam1, test="Chisq")
#Gam is slightly better... not significant

###############################################################################################
#Assess full models
basic_lm <- lm(viability~ passage +treatment+ treatment_time +cohort + days_culture + growth_rate,data = mouseorganoidR)
summary(basic_lm)
termplot(basic_lm, term=1, se=TRUE, col.term=1, col.se=1)

mfit <- lm(viability~ ns(passage, df=3) +treatment+ treatment_time +cohort + ns(days_culture, df=3)+ns(growth_rate, df=5),data = mouseorganoidR)
summary(mfit)
termplot(mfit, term=1, se=TRUE, col.term=1, col.se=1)

mod_gam1 <- gam(viability ~ s(passage, bs = "cs") + s(days_culture, bs = "cs",k=9) +s(growth_rate, bs = "cs") + treatment+ treatment_time +cohort , data=mouseorganoidR)
summary(mod_gam1)

anova(basic_lm,mfit, mod_gam1, test="Chisq")
anova(mfit, mod_gam1, test="Chisq")
#Gam wins in the full model this improves over the basic model from adj r squared of 0.4145 to 0.4979 to 0.556
###############################################################################################

###############################################################################################
#Assess reduced backwards selection
mod_gam_full <- gam(viability ~ s(passage, bs = "cs") + s(days_culture, bs = "cs",k=9)+s(growth_rate, bs = "cs") +treatment+ treatment_time +cohort , data=mouseorganoidR)
summary(mod_gam_full)
# Remove treatment variable

mod_gam1 <- gam(viability ~ s(passage, bs = "cs") + s(days_culture, bs = "cs",k=9)+s(growth_rate, bs = "cs") + treatment_time +cohort , data=mouseorganoidR)
summary(mod_gam1)

anova(mod_gam_full, mod_gam1, test="Chisq")
#Reduced model not significantly improved over full model using likelihood ratio test. 
###############################################################################################

#Regression table
tb_viability_gam <-
 gam(viability ~ s(passage, bs = "cs") + s(days_culture, bs = "cs",k=9)+s(growth_rate, bs = "cs") +treatment+ treatment_time +cohort , data=mouseorganoidR) %>%
  tbl_regression()

tb_viability_gam_flex = as_flex_table(
  tb_viability_gam,
  include = everything(),
  return_calls = FALSE,
  strip_md_bold = TRUE
)

#This produces table in Figure 3D. The specific labels and bold were edited in word following export. 


```
#////Publication plots
```{r}
mod_gam_viability <-gam(viability ~ s(passage, bs = "cs") + s(days_culture, bs = "cs",k=9)+s(growth_rate, bs = "cs") +treatment+ treatment_time +cohort , data=mouseorganoidR)
summary(mod_gam_viability)

predictglm1 = predict(mod_gam_viability)
mouse_adjviability = mouseorganoidR[,c("treatment","treatment_time","passage","viability", "growth_rate")]
mouse_adjviability = na.omit(mouse_adjviability)
mouse_adjviability$adjviability = predictglm1
# Aggregate data and make plots for media and time

#Unadjusted media viability
unadjusted_viability_media = ggplot(mouseorganoidR, aes(x=passage, y=viability, group=treatment, colour=treatment,fill=treatment)) + 
  geom_point(alpha=0.5, colour="black",shape=21, size=2) + 
  geom_smooth(alpha=0.2, size=0) +
  stat_smooth(geom="line", alpha=0.6, size=2) +  scale_x_continuous(name="Passage",limits=c(1,10),breaks=c(1,2,3,4,5,6,7,8,9,10)) +
  ylab("Viability (%)") +
    scale_fill_manual(name="Media",labels=c("HBSS", "UW","HTK"), values = c("#E41A1C", "#377EB8" ,"#4DAF4A")) +
    scale_colour_manual(name="Media",labels=c("HBSS", "UW","HTK"), values = c("#E41A1C", "#377EB8" ,"#4DAF4A")) +
    theme_classic() +
    theme(axis.text.x = element_text(colour="black", size = 14)) +
    theme(axis.text.y = element_text(colour="black",size = 14)) + 
    theme(plot.title = element_text(colour="black", size=14,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_text(colour="black", size =14, vjust = 0.05)) +
    theme(axis.title.y = element_text(colour="black", size=14)) +
    theme(legend.position = "bottom",
          legend.text = element_text(colour="black", size=14),
          legend.title = element_text(colour="black", size=14))
ggsave("unadjusted_viability_media.png", unadjusted_viability_media, width=6, height=4)

#Unadjusted viability facet by cohort
unadjust_media_viability_facet = ggplot(mouseorganoidR, aes(x=passage, y=viability)) + 
  geom_point(alpha=0.5,shape=19, size=2.5) + 
  geom_smooth() + 
  scale_x_continuous(name="Passage",limits=c(1,10),breaks=c(1,2,3,4,5,6,7,8,9,10)) +
  ylab("Viability (%)") +
  ggtitle("Passage vs unadjusted viability by cohort") +
    scale_fill_manual(name="Media",labels=c("HBSS", "UW","HTK"), values = c("#E41A1C", "#377EB8" ,"#4DAF4A")) +
    scale_colour_manual(name="Media",labels=c("HBSS", "UW","HTK"), values = c("#E41A1C", "#377EB8" ,"#4DAF4A")) +
    theme_bw() +
    theme(axis.text.x = element_text(colour="black", size = 14)) +
    theme(axis.text.y = element_text(colour="black",size = 14)) + 
    theme(plot.title = element_text(colour="black", size=16,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_text(colour="black", size =16, vjust = 0.05)) +
    theme(axis.title.y = element_text(colour="black", size=16)) +
    theme(strip.text = element_text(colour="black", size=16)) +
    theme(legend.position = "bottom") + facet_grid(~cohort)
ggsave("unadjust_media_viability_facet.svg", unadjust_media_viability_facet, width=12, height=4)
ggsave("unadjust_media_viability_facet.png", unadjust_media_viability_facet, width=12, height=4)


#Unadjusted dissociation time viability
unadjusted_viability_dissoctime = ggplot(mouseorganoidR, aes(x=passage, y=viability, group=treatment_time, colour=treatment_time,fill=treatment_time)) + 
  geom_point(alpha=0.5, colour="black",shape=21, size=2) + 
  geom_smooth(alpha=0.25, size=0) +
  stat_smooth(geom="line", alpha=0.75, size=2) + 
  scale_x_continuous(name="Passage",limits=c(1,10),breaks=c(1,2,3,4,5,6,7,8,9,10)) +
  ylab("Viability (%)") +
scale_colour_manual(name="Dissociation Time",labels=c("Fresh", "24 Hours","48 Hours"), values = c("#D0D1E6", "#3690C0", "#016C59")) +
  scale_fill_manual(name="Dissociation Time",labels=c("Fresh", "24 Hours","48 Hours"), values = c("#D0D1E6", "#3690C0", "#016C59")) +
  theme_classic() +
    theme(axis.text.x = element_text(colour="black", size = 14)) +
    theme(axis.text.y = element_text(colour="black",size = 14)) + 
    theme(plot.title = element_text(colour="black", size=14,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_text(colour="black", size =14, vjust = 0.05)) +
    theme(axis.title.y = element_text(colour="black", size=14)) +
    theme(legend.position = "bottom",
          legend.text = element_text(colour="black", size=14),
          legend.title = element_text(colour="black", size=14))
ggsave("unadjusted_viability_dissoctime.png", unadjusted_viability_dissoctime, width=6, height=4)


#Adjusted treatment
adjusted_viability_media = ggplot(mouse_adjviability, aes(x=passage, y=adjviability, group=treatment, colour=treatment,fill=treatment)) + 
  geom_point(alpha=0.5, colour="black",shape=21, size=2) + 
  geom_smooth(alpha=0.2, size=0) +
  stat_smooth(geom="line", alpha=0.6, size=2) +
  scale_x_continuous(name="Passage",limits=c(1,10),breaks=c(1,2,3,4,5,6,7,8,9,10)) +
  ylab("Viability (%)") +
    scale_fill_manual(name="Media",labels=c("HBSS", "UW","HTK"), values = c("#E41A1C", "#377EB8" ,"#4DAF4A")) +
    scale_colour_manual(name="Media",labels=c("HBSS", "UW","HTK"), values = c("#E41A1C", "#377EB8" ,"#4DAF4A")) +
    theme_classic() +
    theme(axis.text.x = element_text(colour="black", size = 12)) +
    theme(axis.text.y = element_text(colour="black",size = 12)) + 
    theme(plot.title = element_text(colour="black", size=12,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_text(colour="black", size =12, vjust = 0.05)) +
    theme(axis.title.y = element_text(colour="black", size=12)) +
    theme(legend.position = "bottom",
          legend.text = element_text(colour="black", size=12),
          legend.title = element_text(colour="black", size=12))
ggsave("adjusted_viability_media.svg", adjusted_viability_media, width=5.5, height=3)



#Adjusted treatment time
adjusted_viability_dissoctime = ggplot(mouse_adjviability, aes(x=passage, y=adjviability, group=treatment_time, colour=treatment_time,fill=treatment_time)) + 
  geom_point(alpha=0.5, colour="black",shape=21, size=2) + 
  geom_smooth(alpha=0.25, size=0) +
  stat_smooth(geom="line", alpha=0.75, size=2) +
  scale_x_continuous(name="Passage",limits=c(1,10),breaks=c(1,2,3,4,5,6,7,8,9,10)) +
  ylab("Viability (%)") +
scale_colour_manual(name="Dissociation Time",labels=c("Fresh", "24 Hours","48 Hours"), values = c("#D0D1E6", "#3690C0", "#016C59")) +
  scale_fill_manual(name="Dissociation Time",labels=c("Fresh", "24 Hours","48 Hours"), values = c("#D0D1E6", "#3690C0", "#016C59")) +
  theme_classic() +
    theme(axis.text.x = element_text(colour="black", size = 12)) +
    theme(axis.text.y = element_text(colour="black",size = 12)) + 
    theme(plot.title = element_text(colour="black", size=12,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_text(colour="black", size =12, vjust = 0.05)) +
    theme(axis.title.y = element_text(colour="black", size=12)) +
    theme(legend.position = "bottom",
          legend.text = element_text(colour="black", size=12, hjust=-1),
          legend.title = element_text(colour="black", size=12))
ggsave("adjusted_viability_dissoctime.svg", adjusted_viability_dissoctime, width=5.5, height=4)


####################################################################################
####################################################################################

#Supplement Viability GAM plot 
library(mgcViz)

gam_viability_supplement <- getViz(mod_gam_viability)

print(plot(gam_viability_supplement, allTerms = T), pages = 1)

png(filename="mod_gam_viability_plots.png", width=10, height=6,units="in", res = 300)
print(plot(gam_viability_supplement, allTerms = T), pages = 1)
dev.off()

```


#Complex time models for growth rate 
```{r}
#Viability
require(splines, quietly=TRUE)
nfit1 <- lm(growth_rate~ viability ,data = mouseorganoidR)
nfit2 <- lm(growth_rate~ ns(viability, df=2) ,data = mouseorganoidR)
nfit3 <- lm(growth_rate~ ns(viability, df=3) ,data = mouseorganoidR)
nfit4 <- lm(growth_rate~ ns(viability, df=4),data = mouseorganoidR)
nfit5 <- lm(growth_rate~ ns(viability, df=5),data = mouseorganoidR)
nfit6 <- lm(growth_rate~ ns(viability, df=6),data = mouseorganoidR)

    anova(nfit1, nfit2,nfit3,nfit4,nfit5,nfit6)
    #no cubic spline wins wins

mfit <- lm(growth_rate~ viability,data = mouseorganoidR)
summary(mfit)
termplot(mfit, term=1, se=TRUE, col.term=1, col.se=1)
#Passage

require(splines, quietly=TRUE)
nfit1 <- lm(growth_rate~ passage ,data = mouseorganoidR)
nfit2 <- lm(growth_rate~ ns(passage, df=2) ,data = mouseorganoidR)
nfit3 <- lm(growth_rate~ ns(passage, df=3) ,data = mouseorganoidR)
nfit4 <- lm(growth_rate~ ns(passage, df=4),data = mouseorganoidR)
    anova(nfit1, nfit2,nfit3,nfit4)
    #ns df=3 wins

mfit <- lm(growth_rate~ ns(passage, df=3),data = mouseorganoidR)
summary(mfit)
termplot(mfit, term=1, se=TRUE, col.term=1, col.se=1)

#Days culture
nfit1 <- lm(growth_rate~ days_culture,data = mouseorganoidR)
nfit2 <- lm(growth_rate~  ns(days_culture, df=2),data = mouseorganoidR)
nfit3 <- lm(growth_rate~ ns(days_culture, df=3) ,data = mouseorganoidR)
nfit4 <- lm(growth_rate~ ns(days_culture, df=4) ,data = mouseorganoidR)
nfit5 <- lm(growth_rate~ ns(days_culture, df=5) ,data = mouseorganoidR)
nfit6 <- lm(growth_rate~ ns(days_culture, df=6) ,data = mouseorganoidR)

    anova(nfit1, nfit2,nfit3,nfit4,nfit5,nfit6)
    #ns df=4 wins
    
mfit <- lm(growth_rate~ ns(days_culture, df=4) ,data = mouseorganoidR)
summary(mfit)
termplot(mfit, term=1, se=TRUE, col.term=1, col.se=1)


#Full splines
require(splines, quietly=TRUE)
nfit1 <- lm(growth_rate~ passage +treatment+ treatment_time +cohort + ns(days_culture, df=4) +viability,data = mouseorganoidR)
nfit2 <- lm(growth_rate~ ns(passage, df=2) +treatment+ treatment_time +cohort + ns(days_culture, df=4)+viability,data = mouseorganoidR)
nfit3 <- lm(growth_rate~ ns(passage, df=3) +treatment+ treatment_time +cohort + ns(days_culture, df=4)+viability,data = mouseorganoidR)
nfit4 <- lm(growth_rate~ ns(passage, df=4) +treatment+ treatment_time +cohort + ns(days_culture, df=4),data = mouseorganoidR)+viability
    anova(nfit1, nfit2,nfit3,nfit4)
    #Model nfit3 wins
    
mfit <- lm(growth_rate~ ns(passage, df=3) +treatment+ treatment_time +cohort + ns(days_culture, df=4)+viability,data = mouseorganoidR)
summary(mfit)
termplot(mfit, term=1, se=TRUE, col.term=1, col.se=1)



#Asssess passage spline vs gam
nfit3 <- lm(growth_rate~ ns(passage, df=3) ,data = mouseorganoidR)
library(mgcv)
mod_gam1 <- gam(growth_rate ~ s(passage, bs = "cs"), data=mouseorganoidR)
summary(mod_gam1)

anova(nfit3, mod_gam1, test="Chisq")
#Gam wins

#Assess days_culture spline vs gam
nfit4 <- lm(growth_rate~ ns(days_culture, df=4) ,data = mouseorganoidR)
library(mgcv)
mod_gam1 <- gam(growth_rate ~ s(days_culture, bs = "cs",k=9), data=mouseorganoidR)
summary(mod_gam1)

anova(nfit4, mod_gam1, test="Chisq")
#Gam wins

#Assess full models
basic_lm <- lm(growth_rate~ passage +treatment+ treatment_time +cohort + days_culture+viability,data = mouseorganoidR)
summary(basic_lm)
termplot(basic_lm, term=1, se=TRUE, col.term=1, col.se=1)

mfit <- lm(growth_rate~ ns(passage, df=3) +treatment+ treatment_time +cohort + ns(days_culture, df=4)+viability,data = mouseorganoidR)
summary(mfit)
termplot(mfit, term=1, se=TRUE, col.term=1, col.se=1)

mod_gam1 <- gam(growth_rate ~ s(passage, bs = "cs") + s(days_culture, bs = "cs",k=9) + treatment+ treatment_time +cohort+viability , data=mouseorganoidR)
summary(mod_gam1)

anova(basic_lm,mfit, mod_gam1, test="Chisq")
anova(mfit, mod_gam1, test="Chisq")

#Assess reduced backwards selection
mod_gam_full <- gam(growth_rate ~ s(passage, bs = "cs") + s(days_culture, bs = "cs",k=9) +treatment+ treatment_time +cohort , data=mouseorganoidR)
summary(mod_gam_full)

mod_gam1 <- gam(growth_rate ~ s(passage, bs = "cs") + s(days_culture, bs = "cs",k=9) + treatment_time +cohort , data=mouseorganoidR)
summary(mod_gam1)

anova(mod_gam_full, mod_gam1, test="Chisq")
#Full model wins

#Regression table
tb_growthrate_gam <-
 gam(growth_rate ~ s(passage, bs = "cs") + s(days_culture, bs = "cs",k=9) +treatment+ treatment_time +cohort + viability , data=mouseorganoidR) %>%
  tbl_regression()

tb_growthrate_gam_flex = as_flex_table(
  tb_growthrate_gam,
  include = everything(),
  return_calls = FALSE,
  strip_md_bold = TRUE
)


```
#////Publication plots
```{r}
mod_gam_GR <- gam(growth_rate ~ s(passage, bs = "cs") + s(days_culture, bs = "cs",k=9) +treatment+ treatment_time +cohort+ viability , data=mouseorganoidR)
summary(mod_gam_GR)
predictglm2 = predict(mod_gam_GR)
mouse_adjgrowth = mouseorganoidR[,c("treatment","treatment_time","passage","growth_rate", "viability")]
mouse_adjgrowth = na.omit(mouse_adjgrowth)
mouse_adjgrowth$adjgrowth = predictglm2

#Unadjusted growth_rate facet by cohort
unadjust_media_growth_rate_facet = ggplot(mouseorganoidR, aes(x=passage, y=growth_rate)) + 
  geom_point(alpha=0.5,shape=19, size=2.5) + 
  geom_smooth() + 
  scale_x_continuous(name="Passage",limits=c(1,10),breaks=c(1,2,3,4,5,6,7,8,9,10)) +
  ylab("Relative Growth Rate") +
  ggtitle("Passage vs unadjusted growth rate by cohort") +
    scale_fill_manual(name="Media",labels=c("HBSS", "UW","HTK"), values = c("#E41A1C", "#377EB8" ,"#4DAF4A")) +
    scale_colour_manual(name="Media",labels=c("HBSS", "UW","HTK"), values = c("#E41A1C", "#377EB8" ,"#4DAF4A")) +
    theme_bw() +
    theme(axis.text.x = element_text(colour="black", size = 14)) +
    theme(axis.text.y = element_text(colour="black",size = 14)) + 
    theme(plot.title = element_text(colour="black", size=16,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_text(colour="black", size =16, vjust = 0.05)) +
    theme(axis.title.y = element_text(colour="black", size=16)) +
    theme(strip.text = element_text(colour="black", size=16)) +
    theme(legend.position = "bottom") + facet_grid(~cohort)
ggsave("unadjust_media_growth_rate_facet.svg", unadjust_media_growth_rate_facet, width=12, height=4)
ggsave("unadjust_media_growth_rate_facet.png", unadjust_media_growth_rate_facet, width=12, height=4)


#Unadjusted media growth_rate
unadjusted_growth_rate_media = ggplot(mouseorganoidR, aes(x=passage, y=growth_rate, group=treatment, colour=treatment,fill=treatment)) + 
  geom_point(alpha=0.5, colour="black",shape=21, size=2) + 
  geom_smooth(alpha=0.2, size=0) +
  stat_smooth(geom="line", alpha=0.6, size=2) +  scale_x_continuous(name="Passage",limits=c(1,10),breaks=c(1,2,3,4,5,6,7,8,9,10)) +
  ylab("Growth Rate") +
    scale_fill_manual(name="Media",labels=c("HBSS", "UW","HTK"), values = c("#E41A1C", "#377EB8" ,"#4DAF4A")) +
    scale_colour_manual(name="Media",labels=c("HBSS", "UW","HTK"), values = c("#E41A1C", "#377EB8" ,"#4DAF4A")) +
    theme_classic() +
    theme(axis.text.x = element_text(colour="black", size = 14)) +
    theme(axis.text.y = element_text(colour="black",size = 14)) + 
    theme(plot.title = element_text(colour="black", size=14,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_text(colour="black", size =14, vjust = 0.05)) +
    theme(axis.title.y = element_text(colour="black", size=14)) +
    theme(legend.position = "bottom",
          legend.text = element_text(colour="black", size=14),
          legend.title = element_text(colour="black", size=14))
ggsave("unadjusted_growth_rate_media.png", unadjusted_growth_rate_media, width=6, height=4)


#Unadjusted dissociation time growth_rate
unadjusted_growth_rate_dissoctime = ggplot(mouseorganoidR, aes(x=passage, y=growth_rate, group=treatment_time, colour=treatment_time,fill=treatment_time)) + 
  geom_point(alpha=0.5, colour="black",shape=21, size=2) + 
  geom_smooth(alpha=0.25, size=0) +
  stat_smooth(geom="line", alpha=0.75, size=2) + 
  scale_x_continuous(name="Passage",limits=c(1,10),breaks=c(1,2,3,4,5,6,7,8,9,10)) +
  ylab("Growth Rate") +
scale_colour_manual(name="Dissociation Time",labels=c("Fresh", "24 Hours","48 Hours"), values = c("#D0D1E6", "#3690C0", "#016C59")) +
  scale_fill_manual(name="Dissociation Time",labels=c("Fresh", "24 Hours","48 Hours"), values = c("#D0D1E6", "#3690C0", "#016C59")) +
  theme_classic() +
    theme(axis.text.x = element_text(colour="black", size = 14)) +
    theme(axis.text.y = element_text(colour="black",size = 14)) + 
    theme(plot.title = element_text(colour="black", size=14,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_text(colour="black", size =14, vjust = 0.05)) +
    theme(axis.title.y = element_text(colour="black", size=14)) +
    theme(legend.position = "bottom",
          legend.text = element_text(colour="black", size=14),
          legend.title = element_text(colour="black", size=14))
ggsave("unadjusted_growth_rate_dissoctime.png", unadjusted_growth_rate_dissoctime, width=6, height=4)


#Adjusted treatment
adjusted_growth_rate_media = ggplot(mouse_adjgrowth, aes(x=passage, y=adjgrowth, group=treatment, colour=treatment,fill=treatment)) + 
  geom_point(alpha=0.5, colour="black",shape=21, size=2) + 
  geom_smooth(alpha=0.2, size=0) +
  stat_smooth(geom="line", alpha=0.6, size=2) +
  scale_x_continuous(name="Passage",limits=c(1,10),breaks=c(1,2,3,4,5,6,7,8,9,10)) +
  ylab("Growth Rate") +
    scale_fill_manual(name="Media",labels=c("HBSS", "UW","HTK"), values = c("#E41A1C", "#377EB8" ,"#4DAF4A")) +
    scale_colour_manual(name="Media",labels=c("HBSS", "UW","HTK"), values = c("#E41A1C", "#377EB8" ,"#4DAF4A")) +
    theme_classic() +
    theme(axis.text.x = element_text(colour="black", size = 12)) +
    theme(axis.text.y = element_text(colour="black",size = 12)) + 
    theme(plot.title = element_text(colour="black", size=12,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_text(colour="black", size =12, vjust = 0.05)) +
    theme(axis.title.y = element_text(colour="black", size=12)) +
    theme(legend.position = "bottom",
          legend.text = element_text(colour="black", size=12),
          legend.title = element_text(colour="black", size=12))
ggsave("adjusted_growth_rate_media.svg", adjusted_growth_rate_media, width=5.5, height=3)



#Adjusted treatment time
adjusted_growth_rate_dissoctime = ggplot(mouse_adjgrowth, aes(x=passage, y=adjgrowth, group=treatment_time, colour=treatment_time,fill=treatment_time)) + 
  geom_point(alpha=0.5, colour="black",shape=21, size=2) + 
  geom_smooth(alpha=0.25, size=0) +
  stat_smooth(geom="line", alpha=0.75, size=2) +
  scale_x_continuous(name="Passage",limits=c(1,10),breaks=c(1,2,3,4,5,6,7,8,9,10)) +
  ylab("Growth Rate") +
scale_colour_manual(name="Dissociation Time",labels=c("Fresh", "24 Hours","48 Hours"), values = c("#D0D1E6", "#3690C0", "#016C59")) +
  scale_fill_manual(name="Dissociation Time",labels=c("Fresh", "24 Hours","48 Hours"), values = c("#D0D1E6", "#3690C0", "#016C59")) +
  theme_classic() +
    theme(axis.text.x = element_text(colour="black", size = 12)) +
    theme(axis.text.y = element_text(colour="black",size = 12)) + 
    theme(plot.title = element_text(colour="black", size=12,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_text(colour="black", size =12, vjust = 0.05)) +
    theme(axis.title.y = element_text(colour="black", size=12)) +
    theme(legend.position = "bottom",
          legend.text = element_text(colour="black", size=12, hjust=-1),
          legend.title = element_text(colour="black", size=12))
ggsave("adjusted_growth_rate_dissoctime.svg", adjusted_growth_rate_dissoctime, width=5.5, height=3)


####################################################################################
####################################################################################

#GAM Supplementary Plot

gam_GR_supplement <- getViz(mod_gam_GR)

print(plot(gam_GR_supplement, allTerms = T), pages = 1)

png(filename="mod_gam_GR_plots.png", width=10, height=6,units="in", res = 300)
print(plot(gam_GR_supplement, allTerms = T), pages = 1)
dev.off()

```

## Investigate effect of ischemic time, temperature and age of mouse on dissociation viability

```{r}
#age and temperature effects with consideration of media, dissociation time and cohort. 
multivar_dissviability = dplyr::select(mouseorganoidR, c("diss_viability","temp_media" , "cohort" , "age" ,"treatment" , "treatment_time")) 
multivar_dissviability = na.omit(multivar_dissviability)
  
```

#Table 1
```{r}
diss_viability_notemp_regress <-
  lm(diss_viability ~ cohort + age +treatment + treatment_time, data=mouseorganoidR ) %>%
  tbl_regression()

diss_viability_notemp_regress_flex = as_flex_table(
  diss_viability_notemp_regress,
  include = everything(),
  return_calls = FALSE,
  strip_md_bold = TRUE
)


#Sensitivity analysis of removing the temperature media variable for supplemental
diss_viability_regress <-
  lm(diss_viability ~ temp_media + cohort + age +treatment + treatment_time, data=multivar_dissviability ) %>%
  tbl_regression()

tb_diss_viability_regress_flex = as_flex_table(
  diss_viability_regress,
  include = everything(),
  return_calls = FALSE,
  strip_md_bold = TRUE
)

```
## Lets investigate how stem cell markers play a role using generalized linear models
#TROY and LGR5 assessement
#Figure 4A,B,C,E
```{r}
mouseorganoidR_control$TROY_center = mouseorganoidR_control$TROY - mean(mouseorganoidR_control[mouseorganoidR_control$treatment_time=="Control",]$TROY)
#Reference to mean of whole stomach control samples

mouseorganoidR_control$LGR5_center = mouseorganoidR_control$LGR5 - mean(mouseorganoidR_control[mouseorganoidR_control$treatment_time=="Control",]$LGR5)
#Reference to mean of whole stomach control samples

mouseorganoidR_control$treatment = ifelse(is.na(mouseorganoidR_control$treatment), "Whole Stomach",
                                ifelse(mouseorganoidR_control$treatment=="HBSS", "HBSS",
                                        ifelse(mouseorganoidR_control$treatment=="UW", "UW","HTK")))
mouseorganoidR_control$treatment = as.factor(mouseorganoidR_control$treatment)
mouseorganoidR_control$treatment <- factor(mouseorganoidR_control$treatment, levels = c("Whole Stomach", "HBSS", "UW", "HTK"))

###### Figure 5A LGR5 and TROY by dissociation time
lgr5_dissoc = mouseorganoidR_control %>%
  group_by(treatment) %>%
  ggplot(aes(x = treatment_time, y = LGR5_center, fill=treatment_time )) + 
    geom_violin(alpha=0.4, position = position_dodge(width = .75),size=1,color=NA) +
  geom_boxplot(outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + ggbeeswarm::geom_quasirandom(method = "pseudorandom", shape = 21,size=3.5,dodge.width=0.75,  color="black",alpha=0.5,show.legend = F, bandwidth = 1) +
  geom_hline(yintercept = 0, linetype=2, alpha=0.5) +
  stat_compare_means(size=5.5,label.x=1) +
  scale_y_continuous(name="Log2 relative LGR5 expression",limits = c(-7.5, 5), breaks = c(-7.5,-5,-2.5,0.0,2.5,5),labels = c(-7.5,-5,-2.5,0.0,2.5,5)) +
  scale_x_discrete(name="Dissociation Time",labels=c("Whole Stomach","Fresh", "24 Hours","48 Hours")) +
    scale_fill_manual(name="Dissociation Time",labels=c("Whole Stomach", "Fresh", "24 Hours","48 Hours"), values = c("#FC8D59","#ECE2F0", "#A6BDDB", "#1C9099")) +
    theme_classic() +
    theme(axis.text.x = element_text(colour="black", size = 18,angle = 45, hjust=1, vjust=1)) +
    theme(axis.text.y = element_text(colour="black",size = 18)) + 
    theme(plot.title = element_text(colour="black", size=18,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_blank()) +
    theme(axis.title.y = element_text(colour="black", size=18)) +
    theme(legend.position = "none")
ggsave("lgr5_dissoc.svg", lgr5_dissoc, width=4, height=5)

table(mouseorganoidR_control$LGR5_center>0,mouseorganoidR_control$treatment)


troy_dissoc = mouseorganoidR_control %>%
  group_by(treatment) %>%
  ggplot(aes(x = treatment_time, y = TROY_center, fill=treatment_time )) + 
   geom_violin(alpha=0.4, position = position_dodge(width = .75),size=1,color=NA) +
  geom_boxplot(outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + ggbeeswarm::geom_quasirandom(method = "pseudorandom", shape = 21,size=3.5,dodge.width=0.75,  color="black",alpha=0.5,show.legend = F, bandwidth = 1) +
  geom_hline(yintercept = 0, linetype=2, alpha=0.5) +
  stat_compare_means(size=5.5, label.x=1.05) +
scale_y_continuous(name="Log2 relative TROY expression",limits = c(-7.5, 5), breaks = c(-7.5,-5,-2.5,0.0,2.5,5),labels = c(-7.5,-5,-2.5,0.0,2.5,5)) +  
  scale_x_discrete(name="Dissociation Time",labels=c("Whole Stomach","Fresh", "24 Hours","48 Hours")) +
    scale_fill_manual(name="Dissociation Time",labels=c("Whole Stomach", "Fresh", "24 Hours","48 Hours"), values = c("#FC8D59","#ECE2F0", "#A6BDDB", "#1C9099")) +
theme_classic() +
    theme(axis.text.x = element_text(colour="black", size = 18,angle = 45, hjust=1, vjust=1)) +
    theme(axis.text.y = element_text(colour="black",size = 18)) + 
    theme(plot.title = element_text(colour="black", size=18,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_blank()) +
    theme(axis.title.y = element_text(colour="black", size=18)) +
    theme(legend.position = "none")
ggsave("troy_dissoc.svg", troy_dissoc, width=4, height=5)

#### Figure 5B LGR5 and TROY by media
lgr5_media = mouseorganoidR_control %>%
  group_by(treatment_time) %>%
  filter(!is.na(treatment)) %>%
  ggplot(aes(x = treatment, y = LGR5_center, fill=treatment )) + 
   geom_violin(alpha=0.4, position = position_dodge(width = .75),size=1,color=NA) +
  geom_boxplot(outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + ggbeeswarm::geom_quasirandom(method = "pseudorandom", shape = 21,size=3.5,dodge.width=0.75,  color="black",alpha=0.5,show.legend = F, bandwidth = 1) +
  geom_hline(yintercept = 0, linetype=2, alpha=0.5) +
  stat_compare_means(size=5.5,label.x=1.1) +
scale_y_continuous(name="Log2 relative LGR5 expression",limits = c(-7.5, 5), breaks = c(-7.5,-5,-2.5,0.0,2.5,5),labels = c(-7.5,-5,-2.5,0.0,2.5,5)) +  
  scale_x_discrete(name = "Treatment", labels=c("Whole Stomach","HBSS", "UW", "HTK")) +
    scale_fill_manual(name="Media",labels=c("Whole Stomach","HBSS", "UW","HTK"), values = c("#FC8D59","#E41A1C", "#377EB8" ,"#4DAF4A")) +
theme_classic() +
    theme(axis.text.x = element_text(colour="black", size = 18,angle = 45, hjust=1, vjust=1)) +
    theme(axis.text.y = element_text(colour="black",size = 18)) + 
    theme(plot.title = element_text(colour="black", size=18,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_blank()) +
    theme(axis.title.y = element_text(colour="black", size=18)) +
    theme(legend.position = "none")
ggsave("lgr5_media.svg", lgr5_media, width=4, height=5)

troy_media = mouseorganoidR_control %>%
  group_by(treatment_time) %>%
  filter(!is.na(treatment)) %>%
  ggplot(aes(x = treatment, y = TROY_center, fill=treatment )) + 
   geom_violin(alpha=0.4, position = position_dodge(width = .75),size=1,color=NA) +
  geom_boxplot(outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + ggbeeswarm::geom_quasirandom(method = "pseudorandom", shape = 21,size=3.5,dodge.width=0.75,  color="black",alpha=0.5,show.legend = F, bandwidth = 1) +
  geom_hline(yintercept = 0, linetype=2, alpha=0.5) +
  stat_compare_means(size=5.5, label.x = 1.1) +
scale_y_continuous(name="Log2 relative TROY expression",limits = c(-7.5, 5), breaks = c(-7.5,-5,-2.5,0.0,2.5,5),labels = c(-7.5,-5,-2.5,0.0,2.5,5)) +  
  scale_x_discrete(name = "Treatment", labels=c("Whole Stomach","HBSS", "UW", "HTK")) +
    scale_fill_manual(name="Media",labels=c("Whole Stomach","HBSS", "UW","HTK"), values = c("#FC8D59","#E41A1C", "#377EB8" ,"#4DAF4A")) +
theme_classic() +
    theme(axis.text.x = element_text(colour="black", size = 18,angle = 45, hjust=1, vjust=1)) +
    theme(axis.text.y = element_text(colour="black",size = 18)) + 
    theme(plot.title = element_text(colour="black", size=18,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_blank()) +
    theme(axis.title.y = element_text(colour="black", size=18)) +
    theme(legend.position = "none")
ggsave("troy_media.svg", troy_media, width=4, height=5)

```

```{r}

mouseorganoidR_control_passage = dplyr::filter(mouseorganoidR_control, passage_name=="Whole Stomach" | passage_name=="Passage 0" | passage_name=="Passage 1" | passage_name=="Passage 6")
mouseorganoidR_control_passage$passage_name = factor(mouseorganoidR_control_passage$passage_name)


###LGR5 Dunns
dunn_lgr5 = mouseorganoidR_control_passage %>%
  group_by(treatment_time) %>%
  FSA::dunnTest(LGR5_center ~passage_name,data=.,method="bonferroni")
dunn_lgr5 = dunn_lgr5$res
dunn_lgr5$group1 = c("Passage 0","Passage 0","Passage 1","Passage 0","Passage 1","Passage 6")
dunn_lgr5$group2 = c("Passage 1","Passage 6","Passage 6","Whole Stomach","Whole Stomach","Whole Stomach")
dunn_lgr5$psymbol <- as.character(cut(dunn_lgr5$P.adj, c(0, 0.0001, 0.001, 0.01, 0.05, 1), c("****", "***", "**", "*", "ns")))
dunn_lgr5 =dunn_lgr5 %>%
    slice(4:6,1:3)

#Figure 4C
lgr5_passage = mouseorganoidR_control_passage %>%
  group_by(treatment_time) %>%
  filter(!is.na(passage_name)) %>%
  ggplot(aes(x = passage_name, y = LGR5_center)) + 
  geom_hline(yintercept = 0, linetype=2, alpha=0.5) +
     geom_violin(inherit.aes=FALSE,alpha=0.4, position = position_dodge(width = .75),size=1,color=NA,aes(x = passage_name, y = LGR5_center,fill=passage_name)) +
  geom_boxplot(inherit.aes=FALSE,outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F, aes(x = passage_name, y = LGR5_center,fill=passage_name)) + 
   ggbeeswarm::geom_quasirandom(inherit.aes=FALSE, method = "pseudorandom", shape = 21,size=3.5,dodge.width=0.75,  color="black",alpha=0.5,show.legend = F, bandwidth = 1,aes(x = passage_name, y = LGR5_center,fill=passage_name)) +
  scale_x_discrete(name="Passage number",labels=c("Whole Stomach","Passage 0", "Passage 1","Passage 6")) +
  scale_fill_manual(name="Passage number",labels=c("Whole Stomach", "Passage 0", "Passage 1","Passage 6"), values = c("#FC8D59","#FEE090", "#3288BD","#D53E4F")) +
  stat_pvalue_manual(data = dunn_lgr5, label = "psymbol",xmin = "group1", xmax = "group2",y.position = c( 4.20, 5.05, 5.90, 6.75, 7.60, 8.45), size = 5,tip.length =0.0) +
  stat_compare_means(size=5.5, label.y = -7, label.x= 1, hjust = 0) + # Add global p-value
  scale_y_continuous(name = "Log2 relative LGR5 expression", limits=c(-7.5, 8.5), breaks = c(-7.5,-5,-2.5,0,2.5,5,7.5),labels = c(-7.5,-5,-2.5,0,2.5,5,7.5)) +
  theme_classic() +
    theme(axis.text.x = element_text(colour="black", size = 18,angle = 45, hjust=1, vjust=1)) +
    theme(axis.text.y = element_text(colour="black",size = 18)) + 
    theme(plot.title = element_text(colour="black", size=18,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_blank()) +
    theme(axis.title.y = element_text(colour="black", size=18)) +
    theme(legend.position = "none")
ggsave("lgr5_passage.svg", lgr5_passage, width=4, height=5)
  
###TROY Dunns
dunn_troy = mouseorganoidR_control_passage %>%
  group_by(treatment_time) %>%
  FSA::dunnTest(TROY_center ~passage_name,data=.,method="bonferroni")
dunn_troy = dunn_troy$res
dunn_troy$group1 = c("Passage 0","Passage 0","Passage 1","Passage 0","Passage 1","Passage 6")
dunn_troy$group2 = c("Passage 1","Passage 6","Passage 6","Whole Stomach","Whole Stomach","Whole Stomach")
dunn_troy$psymbol <- as.character(cut(dunn_troy$P.adj, c(0, 0.0001, 0.001, 0.01, 0.05, 1), c("****", "***", "**", "*", "ns")))
dunn_troy =dunn_troy %>%
    slice(4:6,1:3)

mouseorganoidR_control_passage %>%
  group_by(treatment_time) %>%
  filter(!is.na(passage_name)) %>%
  ggplot(aes(x = passage_name, y = TROY_center )) + 
  geom_boxplot() + 
  stat_pvalue_manual(data = dunn_troy, label = "psymbol",xmin = "group1", xmax = "group2",y.position = c(2,2.5,3, 3.5, 4, 4.5)) +
stat_compare_means(size=4, label.y = -7, vjust = 1) + # Add global p-value
  scale_y_continuous(name = "Log2 relative LGR5 expression", limits=c(-7.5, 8.5), breaks = c(-7.5,-5,-2.5,0,2.5,5,7.5),labels = c(-7.5,-5,-2.5,0,2.5,5,7.5)) 

#Figure 4E
troy_passage = mouseorganoidR_control_passage %>%
  group_by(treatment_time) %>%
  filter(!is.na(passage_name)) %>%
  ggplot(aes(x = passage_name, y = TROY_center)) + 
  geom_hline(yintercept = 0, linetype=2, alpha=0.5) +
 geom_violin(inherit.aes=FALSE,alpha=0.4, position = position_dodge(width = .75),size=1,color=NA,aes(x = passage_name, y = TROY_center,fill=passage_name)) +
  geom_boxplot(inherit.aes=FALSE,outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F, aes(x = passage_name, y = TROY_center,fill=passage_name)) + 
   ggbeeswarm::geom_quasirandom(inherit.aes=FALSE, method = "pseudorandom", shape = 21,size=3.5,dodge.width=0.75,  color="black",alpha=0.5,show.legend = F, bandwidth = 1,aes(x = passage_name, y = TROY_center,fill=passage_name)) +  scale_x_discrete(name="Passage number",labels=c("Whole Stomach","Passage 0", "Passage 1","Passage 6")) +
  scale_fill_manual(name="Passage number",labels=c("Whole Stomach", "Passage 0", "Passage 1","Passage 6"), values = c("#FC8D59","#FEE090", "#3288BD","#D53E4F")) +
  stat_pvalue_manual(data = dunn_troy, label = "psymbol",xmin = "group1", xmax = "group2",y.position = c( 4.20, 5.05, 5.90, 6.75, 7.60, 8.45), size = 5,tip.length =0.0) +
  stat_compare_means(size=5.5, label.y = -7, label.x= 1, hjust = 0) + # Add global p-value
  scale_y_continuous(name = "Log2 relative TROY expression", limits=c(-7.5, 8.5), breaks = c(-7.5,-5,-2.5,0,2.5,5,7.5),labels = c(-7.5,-5,-2.5,0,2.5,5,7.5)) +
  theme_classic() +
    theme(axis.text.x = element_text(colour="black", size = 18,angle = 45, hjust=1, vjust=1)) +
    theme(axis.text.y = element_text(colour="black",size = 18)) + 
    theme(plot.title = element_text(colour="black", size=18,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_blank()) +
    theme(axis.title.y = element_text(colour="black", size=18)) +
    theme(legend.position = "none")
ggsave("troy_passage.svg", troy_passage, width=4, height=5)
```

#Multivariable LGR5 and TROY models
```{r}
#Multivaraible models over time
troy_lm = lm(TROY_center~ passage + cohort+ treatment + treatment_time,data = mouseorganoidR_control_passage)
lgr5_lm = lm(LGR5_center~ passage + cohort+ treatment + treatment_time,data = mouseorganoidR_control_passage)

ggplot(mouseorganoidR_control_passage, aes(x = passage_name, y =TROY_center )) +geom_point() + geom_smooth()

lgr5_gam = gam(LGR5_center ~ s(passage, bs="cs",k=3) + cohort + treatment + treatment_time,data = mouseorganoidR_control_passage)
summary(lgr5_gam)
lgr5_gam_plot <- getViz(lgr5_gam)
print(plot(lgr5_gam_plot, allTerms = T), pages = 1)


troy_gam = gam(TROY_center ~ s(passage, bs="cs",k=3) + cohort + treatment + treatment_time,data = mouseorganoidR_control_passage)
summary(troy_gam)
troy_gam_plot <- getViz(troy_gam)
print(plot(troy_gam_plot, allTerms = T), pages = 1)


#Regression table LGR5
tb_lgr5_gam <-
 gam(LGR5_center ~ s(passage, bs="cs",k=3) + cohort + treatment + treatment_time,data = mouseorganoidR_control_passage) %>%
  tbl_regression()

tb_lgr5_gam_flex = as_flex_table(
  tb_lgr5_gam,
  include = everything(),
  return_calls = FALSE,
  strip_md_bold = TRUE
)
 


#Regression table TROY
tb_troy_gam <-
 gam(TROY_center ~ s(passage, bs="cs",k=3) + cohort + treatment + treatment_time,data = mouseorganoidR_control_passage) %>%
  tbl_regression()

tb_troy_gam_flex = as_flex_table(
  tb_troy_gam,
  include = everything(),
  return_calls = FALSE,
  strip_md_bold = TRUE
)
 
```
#Figure 5 Multivariable GAM TROY and LGR5
```{r}
#######
troy_passage_plot = plot( sm(troy_gam_plot, 1) )
troy_passage_plot_data = troy_passage_plot$ggObj$data


troy_gamplot = ggplot(troy_passage_plot_data, aes(x = x, y=y)) +
  geom_vline(xintercept = c(0,1,6), linetype=2)+
  geom_line(colour = "#1F78B4", size=2) +
  geom_line(inherit.aes = FALSE, aes(x=x, y=(y+(1.96*se))), colour = "#1F78B4", linetype=2, size=1) +
  geom_line(inherit.aes = FALSE, aes(x=x, y=(y-(1.96*se))),colour = "#1F78B4",linetype=2, size=1) +
  scale_x_continuous(breaks=c(0,1,2,3,4,5,6), labels=c(0,1,2,3,4,5,6)) +
  ylim(-2.5,2.5) +
  ylab("Partial effect of passage number on TROY\nexpression according to [s(Passage, 1.92)]") +
  xlab("Passage number") +
  theme_bw() +
    theme(axis.text.x = element_text(colour="black", size = 16)) +
    theme(axis.text.y = element_text(colour="black",size = 16)) + 
    theme(plot.title = element_text(colour="black", size=16,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_text(colour="black",size = 16)) +
    theme(axis.title.y = element_text(colour="black", size=16)) +
    theme(legend.position = "none")
ggsave("troy_gamplot.svg", troy_gamplot, width =7, height=5)

lgr5_passage_plot = plot( sm(lgr5_gam_plot, 1) )
lgr5_passage_plot_data = lgr5_passage_plot$ggObj$data

lgr5_gamplot = ggplot(lgr5_passage_plot_data, aes(x = x, y=y)) +
  geom_vline(xintercept = c(0,1,6), linetype=2)+
  geom_line(colour = "#33A02C", size=2) +
  geom_line(inherit.aes = FALSE, aes(x=x, y=(y+(1.96*se))), colour = "#33A02C", linetype=2, size=1) +
  geom_line(inherit.aes = FALSE, aes(x=x, y=(y-(1.96*se))),colour = "#33A02C",linetype=2, size=1) +
  scale_x_continuous(breaks=c(0,1,2,3,4,5,6), labels=c(0,1,2,3,4,5,6)) +
  ylim(-2.5,2.5) +
  ylab("Partial effect of passage number on LGR5\nexpression according to [s(Passage, 1.92)]") +
  xlab("Passage number") +
  theme_bw() +
    theme(axis.text.x = element_text(colour="black", size = 16)) +
    theme(axis.text.y = element_text(colour="black",size = 16)) + 
    theme(plot.title = element_text(colour="black", size=16,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_text(colour="black",size = 16)) +
    theme(axis.title.y = element_text(colour="black", size=16)) +
    theme(legend.position = "none")
ggsave("lgr5_gamplot.svg", lgr5_gamplot, width =7, height=5)


troy_passage_plot_data$model = "TROY"
lgr5_passage_plot_data$model = "LGR5"
combo_gam = rbind(lgr5_passage_plot_data,troy_passage_plot_data)

ggplot(combo_gam, aes(x = x, y=y, colour=model)) +
  geom_vline(xintercept = c(0,1,6), linetype=2)+
  geom_line(size=2) +
  geom_line(inherit.aes = FALSE, aes(x=x, y=(y+(1.96*se)), colour=model), linetype=2, size=1) +
  geom_line(inherit.aes = FALSE, aes(x=x, y=(y-(1.96*se)), colour=model),linetype=2, size=1) +
  scale_x_continuous(breaks=c(0,1,2,3,4,5,6), labels=c(0,1,2,3,4,5,6)) +
  scale_colour_manual(values = c("#33A02C","#1F78B4")) +
  ylim(-2.5,2.5) +
  ylab("Partial effect of passage number on LGR5\nexpression according to [s(Passage, 1.92)]") +
  xlab("Passage number") +
  theme_bw() +
    theme(axis.text.x = element_text(colour="black", size = 16)) +
    theme(axis.text.y = element_text(colour="black",size = 16)) + 
    theme(plot.title = element_text(colour="black", size=16,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_text(colour="black",size = 16)) +
    theme(axis.title.y = element_text(colour="black", size=16)) +
    theme(legend.position = "none")

combo_passage_gam_plot = ggplot(combo_gam, aes(x = x, y=y, colour=model)) +
  geom_vline(xintercept = c(0,1,6), linetype=2)+
  geom_line(size=2) +
  geom_ribbon(inherit.aes = FALSE, aes(x=x,ymin=(y-(1.96*se)), ymax=(y+(1.96*se)), colour=model, fill=model),alpha=0.2, linetype=2, size=0) +
  scale_x_continuous(breaks=c(0,1,2,3,4,5,6), labels=c(0,1,2,3,4,5,6)) +
  scale_fill_manual(name="Partial effects for:",values = c("#33A02C","#1F78B4")) +
  scale_colour_manual(name="Partial effects for:",values = c("#33A02C","#1F78B4")) +
  ylim(-2.5,2.5) +
  ylab("Partial effect of passage number\non gene expression") +
  xlab("Passage number") +
  ggtitle("Multivariable relationship of gene expression vs. passage number") +
  theme_bw() +
    theme(axis.text.x = element_text(colour="black", size = 16)) +
    theme(axis.text.y = element_text(colour="black",size = 16)) + 
    theme(plot.title = element_text(colour="black", size=16,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_text(colour="black",size = 16)) +
    theme(axis.title.y = element_text(colour="black", size=16)) +
    theme(legend.position = c(0.6, 0.3),
          legend.title = element_text(colour="black", size = 16),
          legend.text = element_text(colour="black", size = 16))
ggsave("combo_passage_gam_plot.svg", combo_passage_gam_plot, width =10, height=5)

check(troy_gam_plot,
      a.qq = list(method = "tnorm", 
                  a.cipoly = list(fill = "light blue")), 
      a.respoi = list(size = 0.5), 
      a.hist = list(bins = 10))
```

#Mean gene expression per treatment and correlation plots
```{r}
###For both drug assays these are the gene expression values from the passage preceding the drug assay. Thus this is a consistent estimate of gene expression relationship to drug assay. 
cohort5_dose = mouseorganoidR_control
cohort5_dose = dplyr::filter(cohort5_dose, !passage_name == "Passage 0")
cohort5_dose = dplyr::filter(cohort5_dose, cohort == "5")
cohort5_dose = dplyr::select(cohort5_dose, c("treatment", "treatment_time", "passage_name", "TROY_center", "LGR5_center"))
cohort5_dose = na.omit(cohort5_dose)
#write.csv(cohort5_dose, "cohort5_dose.csv")
#add in ic50 values from Graphpad analysis

urlfile<-'https://raw.githubusercontent.com/skubleny/mouse-organoid/main/Raw%20Data/cohort5_dose.csv'
cohort5_dose<-read.csv(urlfile, row.names=1)

#Figure 2F
troy_drug_correlation = ggplot(cohort5_dose, aes(x = TROY_center, y = ic50)) + 
  geom_point(inherit.aes=FALSE, data= cohort5_dose, aes(x = TROY_center, y = ic50, fill = passage_name), shape=21, colour="black",size=4) + 
  xlab("Log2 TROY Expression") +
  ylab("Log IC50") +
  scale_fill_manual(name="Passage", values=c("#3288BD","#D53E4F")) +
  stat_cor(method="pearson", size=5) + 
  geom_smooth(method="lm", colour="black", se=FALSE, linetype=2) +
  theme_classic() +
    theme(axis.text.x = element_text(colour="black", size = 14)) +
    theme(axis.text.y = element_text(colour="black",size = 14)) + 
    theme(plot.title = element_text(colour="black", size=14,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_text(colour="black",size = 14)) +
    theme(axis.title.y = element_text(colour="black", size=14)) +
    theme(legend.position = "bottom",
          legend.title = element_text(colour="black", size = 14),
          legend.text = element_text(colour="black", size = 14))
ggsave("troy_drug_correlation.svg", troy_drug_correlation, width =4, height=3)

#Figure 2E
lgr5_drug_correlation = ggplot(cohort5_dose, aes(x = LGR5_center, y = ic50)) + 
  geom_point(inherit.aes=FALSE, data= cohort5_dose, aes(x = LGR5_center, y = ic50, fill = passage_name), shape=21, colour="black",size=4) + 
  xlab("Log2 LGR5 Expression") +
  ylab("Log IC50") +
  scale_fill_manual(name="Passage", values=c("#3288BD","#D53E4F")) +
  stat_cor(method="pearson", size=5) + 
  geom_smooth(method="lm", colour="black", se=FALSE, linetype=2) +
  theme_classic() +
    theme(axis.text.x = element_text(colour="black", size = 14)) +
    theme(axis.text.y = element_text(colour="black",size = 14)) + 
    theme(plot.title = element_text(colour="black", size=14,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_text(colour="black",size = 14)) +
    theme(axis.title.y = element_text(colour="black", size=14)) +
    theme(legend.position = "bottom",
          legend.title = element_text(colour="black", size = 14),
          legend.text = element_text(colour="black", size = 14))
ggsave("lgr5_drug_correlation.svg", lgr5_drug_correlation, width =4, height=3)

```
##Figure 5B Passage 2 vs 6 wilcox paired
```{r}
####
mean_troy = mouseorganoidR_control %>% 
  group_by(treatment,treatment_time,passage_name) %>%
  summarise(mean = mean(TROY_center,na.rm = TRUE), sd = sd(TROY,na.rm = TRUE), non_na_count = sum(!is.na(TROY_center)))

mean_troy = na.omit(mean_troy)
mean_troy = dplyr::filter(mean_troy, !passage_name == "Passage 0")

#write.csv(mean_troy, "mean_troy.csv")
#Add in ic50 values from Graphpad analysis

urlfile<-'https://raw.githubusercontent.com/skubleny/mouse-organoid/main/Raw%20Data/mean_troy.csv'
mean_troy<-read.csv(urlfile, row.names=1)
###

doseresponse_paired = mean_troy
doseresponse_paired$id = paste("Organoid",rep(seq(1:9),2))
doseresponse_paired$id = as.factor(doseresponse_paired$id)
doseresponse_paired$passage_name = as.factor(doseresponse_paired$passage_name)

#Figure 5B
doseresp_paired = ggpaired(doseresponse_paired, x = "passage_name", y = "ic50",
 color = "black", line.color = "gray60", line.size = 1, fill="passage_name", palette = "jco") + 
  ylab("Log10 IC50") +
  ggtitle("Paired Dose-Response") + 
  scale_x_discrete(name = "Passage Number", label = c("Passage 1", "Passage 6")) +
  stat_compare_means(paired = TRUE, size=5, label.y = 3.85) +
  geom_point(inherit.aes = FALSE,data =doseresponse_paired, aes(x = passage_name, y = ic50, fill= passage_name), shape=21,colour="black", size=3, alpha = 0.8, stroke=2) +
  scale_fill_manual(values=c("#3288BD","#D53E4F")) + 
  theme_classic() +
  theme(axis.text.x = element_text(colour="black", size = 16)) +
  theme(axis.text.y = element_text(colour="black",size = 16)) + 
  theme(plot.title = element_text(colour="black", size=16,hjust = 0, vjust=0)) +
  theme(axis.title.x = element_text(colour="black", size =16, vjust = 0.05)) +
  theme(axis.title.y = element_text(colour="black", size=16)) +
  theme(legend.position = "none")
ggsave("doseresp_paired.svg",doseresp_paired,width=6, height=4)
```
#IC50 by media and dissociation time
```{r}
doseresp_paired_media = Rmisc::summarySE(doseresponse_paired, (measurevar="ic50"), groupvars=c("treatment"))

doseresp_paired_treatment = Rmisc::summarySE(doseresponse_paired, (measurevar="ic50"), groupvars=c("treatment_time"))

#Figure 5C
treatment_ic50 = ggplot(doseresp_paired_treatment, aes(x = treatment_time, y =ic50, fill=treatment_time)) + 
    geom_bar(stat="identity", color="black", position=position_dodge()) + 
    geom_errorbar(aes(ymin = ic50,ymax = ic50+sd),position=position_dodge(.9), width=.2) + 
    stat_compare_means(inherit.aes = FALSE, data=doseresp_paired_treatment, aes(x = treatment_time, y =ic50, fill =  treatment_time), size=5.5, label.y = 4, label.x =1) +
    ylab("Log10 IC50") +
    ylim(0,4.2)+
    scale_x_discrete(name="Dissociation Time",labels=c("Fresh", "24 Hours","48 Hours")) +
    scale_fill_manual(name="Dissociation Time",labels=c("Fresh", "24 Hours","48 Hours"), values = c("#ECE2F0", "#A6BDDB", "#1C9099")) +
    theme_classic() +
    theme(axis.text.x = element_text(colour="black", size = 16)) +
    theme(axis.text.y = element_text(colour="black",size = 16)) + 
    theme(plot.title = element_text(colour="black", size=16,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_text(colour="black", size =16, vjust = 0.05)) +
    theme(axis.title.y = element_text(colour="black", size=16)) +
    theme(legend.position = "none") 
  ggsave("treatment_ic50.svg", treatment_ic50, width=3.75, height=4)

#Figure 5D
media_ic50 = ggplot(doseresp_paired_media, aes(x = treatment, y =ic50, fill=treatment)) + 
    geom_bar(stat="identity", color="black", position=position_dodge()) + 
    geom_errorbar(aes(ymin = ic50,ymax = ic50+sd),position=position_dodge(.9), width=.2) + 
    stat_compare_means(inherit.aes = FALSE, data=doseresp_paired_media, aes(x = treatment, y =ic50, fill =  treatment), size=5.5, label.y = 4, label.x =1) +
    ylab("Log10 IC50") +
    ylim(0,4.2)+
    scale_x_discrete(name = "Media", labels=c("HBSS", "UW", "HTK")) +
    scale_fill_manual(name="Media",labels=c("HBSS", "UW","HTK"), values = c("#E41A1C", "#377EB8" ,"#4DAF4A")) +
    theme_classic() +
    theme(axis.text.x = element_text(colour="black", size = 16)) +
    theme(axis.text.y = element_text(colour="black",size = 16)) + 
    theme(plot.title = element_text(colour="black", size=16,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_text(colour="black", size =16, vjust = 0.05)) +
    theme(axis.title.y = element_text(colour="black", size=16)) +
    theme(legend.position = "none") 
  ggsave("media_ic50.svg", media_ic50, width=3.75, height=4)

```

#Viability and establishing human gastric cancer organoids
```{r}


urlfile<-'https://raw.githubusercontent.com/skubleny/mouse-organoid/main/Raw%20Data/human%20organoid%20viability.csv'
huorgvia<-read.csv(urlfile)


huorgvia$sample_id = as.factor(huorgvia$sample_id)
huorgvia$Cohort = as.factor(huorgvia$Cohort)
huorgvia$Cohort2 = as.factor(huorgvia$Cohort2)
huorgvia$Established = as.factor(huorgvia$Established)
huorgvia$Cohort2 <- factor(huorgvia$Cohort2, levels = c("Fresh", "24/48"))


huorgvia$live = as.numeric(huorgvia$live)
huorgvia$dead = as.numeric(huorgvia$dead)
huorgvia$Viability = huorgvia$Viability*100

human_organoid_dissviab = huorgvia %>%
ggplot(aes(x= Cohort2, y = Viability, fill = Cohort2)) + 
 geom_violin(alpha=0.4, position = position_dodge(width = .75),size=1,color=NA, scale = "count") +
  geom_boxplot(outlier.size = -1, color="black",lwd=1, alpha = 0.2,show.legend = F) + ggbeeswarm::geom_quasirandom(method = "quasirandom", shape = 21,size=3,dodge.width=0.75,  color="black",alpha=0.5,show.legend = F, bandwidth = 1) + 
  stat_compare_means(size = 4.5, label.y = 10, label.x=1, hjust=0.5) +
  ylim(0,100) +
  ylab("Dissociation viability (%)") +
    xlab("Cell Status") +
    scale_x_discrete(name = "Media", labels=c("Fresh", "24/48")) +
    scale_fill_manual(name="Media",labels=c("Fresh", "24/48"), values = c("#ECE2F0","#1C9099")) +
    theme_classic() +
    theme(axis.text.x = element_text(colour="black", size = 14)) +
    theme(axis.text.y = element_text(colour="black",size = 14)) + 
    theme(plot.title = element_text(colour="black", size=14,hjust = 0, vjust=0)) +
    theme(axis.title.x = element_text(colour="black", size =14, vjust = 0.05)) +
    theme(axis.title.y = element_text(colour="black", size=14)) +
    theme(legend.position = "none")
ggsave("human_organoid_dissviab.svg", human_organoid_dissviab, width=4, height=3)

table(huorgvia$Established,huorgvia$Cohort2)
fisher.test(huorgvia$Established,huorgvia$Cohort2)
```
